# 玩家战绩分析器架构文档 v2

## 🎯 核心设计思想

### **策略模式的核心目的**
- **排位模式**：完整的5层深度分析（核心功能）
- **其他模式**：简化的2层基础分析（快速展示，节省资源）

### **独立阈值管理**
- 所有阈值独立维护在 `thresholds.rs`
- 便于后续调整和实验
- 支持自定义算法实现

---

## 📂 文件结构

```
src-tauri/src/lcu/player_stats_analyzer/
├── mod.rs                        # 模块导出
├── ARCHITECTURE.md               # 本文档
│
├── parser.rs                     # 🔧 数据解析层
├── strategy.rs                   # 🎯 策略模式（决定分析深度）
├── thresholds.rs                 # ⚙️  阈值配置（独立维护）
│
├── analyzer.rs                   # 📊 量化计算
├── traits_analyzer.rs            # 🏷️  基础特征
├── advanced_analyzer.rs          # 🔬 深度特征（仅排位）
├── role_analyzer.rs              # 🎮 位置特征（仅排位）
├── distribution_analyzer.rs      # 📈 分布特征（仅排位）
└── trait_merger.rs               # ✨ 去重优化
```

---

## 🏗️ 完整分析流程

```
┌─────────────────────────────────────────────────────────────┐
│ 原始 LCU JSON 数据                                           │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 第1步: Parser 层 (parser.rs)                                 │
│ - 解析 JSON → ParsedGame                                     │
│ - 隔离 API 变化                                              │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 第2步: Strategy 层 (strategy.rs)                             │
│ - 识别队列类型 (420/440 → Ranked, 其他 → Other)             │
│ - 决定分析深度                                               │
│   • Ranked: 5层完整分析                                      │
│   • Other:  2层简化分析                                      │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 第3步: Analyzer 层 (analyzer.rs + thresholds.rs)            │
│ - 量化指标计算（基于 ParsedGame）                            │
│ - 使用 thresholds.rs 的阈值配置                              │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 第4步: 特征分析层（根据 Strategy 决定执行哪些）              │
│                                                              │
│ ┌────────────────────────────────────────────┐              │
│ │ Layer 1: 基础特征 (traits_analyzer.rs)     │ ← 所有模式   │
│ │ - 胜率、KDA、连胜                           │              │
│ └────────────────────────────────────────────┘              │
│                                                              │
│ ┌────────────────────────────────────────────┐              │
│ │ Layer 2: 深度特征 (advanced_analyzer.rs)   │ ← 仅排位     │
│ │ - 参团率、伤害占比、稳定性、趋势            │              │
│ └────────────────────────────────────────────┘              │
│                                                              │
│ ┌────────────────────────────────────────────┐              │
│ │ Layer 3: 位置特征 (role_analyzer.rs)       │ ← 仅排位     │
│ │ - 位置识别、位置专项分析                    │              │
│ └────────────────────────────────────────────┘              │
│                                                              │
│ ┌────────────────────────────────────────────┐              │
│ │ Layer 4: 分布特征 (distribution_analyzer)  │ ← 仅排位     │
│ │ - 高光时刻、崩盘场次、稳定性分布            │              │
│ └────────────────────────────────────────────┘              │
│                                                              │
│ ┌────────────────────────────────────────────┐              │
│ │ Layer 5: 胜负模式 (analyze_win_loss)       │ ← 所有模式   │
│ │ - 近期状态                                  │              │
│ └────────────────────────────────────────────┘              │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 第5步: 去重优化 (trait_merger.rs)                            │
│ - 合并相似特征                                               │
│ - 限制数量: 排位12个 / 其他6个                               │
└────────────────┬────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 最终输出: PlayerMatchStats                                   │
│ - 完整量化指标 + 精炼特征标签                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎮 两种策略对比

| 特性 | 排位模式 (Ranked) | 其他模式 (Other) |
|------|------------------|-----------------|
| **队列** | 420/440 | 所有其他队列 |
| **定位** | 核心深度分析 | 快速简化分析 |
| **分析层数** | 5层完整 | 2层基础 |
| **基础特征** | ✅ | ✅ |
| **深度特征** | ✅ | ❌ |
| **位置分析** | ✅ | ❌ |
| **分布分析** | ✅ | ❌ |
| **胜负模式** | ✅ | ✅ |
| **特征数量** | 12个 | 6个 |
| **计算开销** | 高 | 低 |

---

## ⚙️ 阈值配置 (thresholds.rs)

所有阈值独立维护，便于调整：

```rust
// 胜率阈值
pub mod win_rate {
    pub const EXCELLENT_RANKED: f64 = 65.0;  // 排位大神
    pub const EXCELLENT_OTHER: f64 = 60.0;   // 其他模式大神
}

// KDA阈值
pub mod kda {
    pub const EXCELLENT_RANKED: f64 = 4.0;
    pub const EXCELLENT_OTHER: f64 = 3.5;
}

// 位置相关阈值
pub mod damage_share {
    pub fn for_role(role: &str) -> (f64, f64) { ... }
}
```

---

## 🔄 如何修改和扩展

### **1. LCU API 变更**
只需修改 `parser.rs`：
```rust
// parser.rs
fn parse_player_data(participant: &Value) -> Option<ParsedPlayerData> {
    // 这里适配新的 API 字段
}
```

### **2. 调整阈值**
只需修改 `thresholds.rs`：
```rust
// thresholds.rs
pub mod win_rate {
    pub const EXCELLENT_RANKED: f64 = 70.0; // 提高标准
}
```

### **3. 新增策略**
在 `strategy.rs` 添加新策略：
```rust
pub enum AnalysisStrategy {
    Ranked,
    Aram,    // 新增：大乱斗特殊策略
    Other,
}
```

### **4. 新增分析维度**
创建新的分析器文件：
```rust
// new_analyzer.rs
pub fn analyze_new_feature(stats: &PlayerMatchStats) -> Vec<SummonerTrait> {
    // 你的新算法
}
```

### **5. 修改分析流程**
在 `matches/service.rs` 调整：
```rust
if strategy.enable_your_new_analysis() {
    traits.extend(analyze_new_feature(&player_stats));
}
```

---

## 🎯 设计优势

### **1. 可维护性极高**
- API 变更 → 只改 `parser.rs`
- 阈值调整 → 只改 `thresholds.rs`
- 策略变更 → 只改 `strategy.rs`

### **2. 性能优化**
- 排位模式：深度分析，提供最大价值
- 其他模式：简化分析，节省资源

### **3. 易于实验**
- 阈值独立，可以快速调整测试
- 策略清晰，可以A/B测试不同方案

### **4. 代码清晰**
- 每个模块职责单一
- 依赖关系清晰
- 易于理解和修改

---

## 📊 实际效果

### **排位模式日志示例**：
```
🎯 Strategy: 排位模式 - 核心深度分析 (queueId=420)
📊 分析方案: 5层完整分析（基础→深度→位置→分布→胜负）
✅ 分析完成 (Ranked):
   总对局=20, 胜场=13, 胜率=65.0%
   识别特征: 12个 (限制12个)
```

### **其他模式日志示例**：
```
🎯 Strategy: 娱乐模式 - 快速简化分析 (queueId=450)
📊 分析方案: 2层简化分析（基础→简单胜负）
✅ 分析完成 (Other):
   总对局=20, 胜场=12, 胜率=60.0%
   识别特征: 6个 (限制6个)
```

---

## 🚀 未来扩展方向

1. **自定义算法实验**
   - 在 `thresholds.rs` 添加新的阈值集合
   - 在分析器中实验新的评分算法

2. **更多策略**
   - ARAM 特殊策略（高KDA标准）
   - Arena 特殊策略（2v2评价）
   - 训练模式策略（不分析）

3. **机器学习集成**
   - 使用历史数据训练阈值
   - 动态调整评价标准

4. **性能监控**
   - 统计各分析层的耗时
   - 优化慢速分析器

---

*最后更新: 2025-10-17*

