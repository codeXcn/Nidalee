<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product 
    Id="{{product-id}}" 
    Name="{{product-name}}" 
    Language="2052" 
    Codepage="936"
    Version="{{version}}" 
    Manufacturer="{{manufacturer}}" 
    UpgradeCode="{{upgrade-code}}">
    
    <Package 
      Id="*" 
      Keywords="Installer" 
      Description="{{product-name}} 安装程序" 
      Manufacturer="{{manufacturer}}" 
      InstallerVersion="200" 
      Languages="2052" 
      Compressed="yes" 
      SummaryCodepage="936" />

    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- 添加中文语言包支持 -->
    <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />
    
    <!-- 自定义属性 -->
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPURLINFOABOUT" Value="{{homepage}}" />
    <Property Id="ARPHELPLINK" Value="{{homepage}}" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
    <Property Id="ARPNOREPAIR" Value="no" Secure="yes" />
    <Property Id="ARPCOMMENTS" Value="英雄联盟游戏助手 - 提供实时游戏数据分析和自动化功能" />
    
    <!-- 图标设置 -->
    <Icon Id="ProductIcon" SourceFile="icons/icon.ico" />

    <!-- 目录结构 -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="{{program-files-dir}}" Name="{{program-files-dir-name}}">
        <Directory Id="INSTALLDIR" Name="{{product-name}}">
          {{#each app_exe_source}}
          <Component Id="{{this.id}}" Guid="{{this.guid}}">
            <File Id="{{this.id}}" Source="{{this.source}}" KeyPath="yes" />
          </Component>
          {{/each}}

          {{#each file_associations}}
          <Component Id="{{this.id}}" Guid="{{this.guid}}">
            <ProgId Id="{{this.prog_id}}" Description="{{this.description}}">
              <Extension Id="{{this.ext}}" ContentType="{{this.mime_type}}">
                <Verb Id="open" Command="打开" TargetFile="{{this.app_exe_id}}" />
              </Extension>
            </ProgId>
          </Component>
          {{/each}}

          {{#each directories}}
          {{> directory.wxs}}
          {{/each}}

          {{#each files}}
          <Component Id="{{this.id}}" Guid="{{this.guid}}">
            {{#if this.is_key_path}}
            <File Id="{{this.id}}" Source="{{this.source}}" KeyPath="yes" />
            {{else}}
            <File Id="{{this.id}}" Source="{{this.source}}" />
            {{/if}}
          </Component>
          {{/each}}
        </Directory>
      </Directory>

      <!-- 开始菜单快捷方式 -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="{{product-name}}">
          <Component Id="ApplicationShortcuts" Guid="{{shortcuts-guid}}">
            <Shortcut Id="ApplicationStartMenuShortcut" 
                     Name="{{product-name}}" 
                     Description="英雄联盟游戏助手" 
                     Target="[INSTALLDIR]{{app-exe-name}}" 
                     WorkingDirectory="INSTALLDIR" />
            
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" 
                          Key="Software\{{manufacturer}}\{{product-name}}" 
                          Name="installed" 
                          Type="integer" 
                          Value="1" 
                          KeyPath="yes" />
          </Component>
        </Directory>
      </Directory>

      <!-- 桌面快捷方式 -->
      <Directory Id="DesktopFolder">
        <Component Id="DesktopShortcuts" Guid="{{desktop-guid}}">
          <Shortcut Id="ApplicationDesktopShortcut" 
                   Name="{{product-name}}" 
                   Description="英雄联盟游戏助手" 
                   Target="[INSTALLDIR]{{app-exe-name}}" 
                   WorkingDirectory="INSTALLDIR" />
          
          <RegistryValue Root="HKCU" 
                        Key="Software\{{manufacturer}}\{{product-name}}" 
                        Name="desktop_shortcut" 
                        Type="integer" 
                        Value="1" 
                        KeyPath="yes" />
        </Component>
      </Directory>
    </Directory>

    <!-- 功能定义 -->
    <Feature Id="Complete" Title="{{product-name}}" Level="1">
      {{#each app_exe_source}}
      <ComponentRef Id="{{this.id}}" />
      {{/each}}

      {{#each file_associations}}
      <ComponentRef Id="{{this.id}}" />
      {{/each}}

      {{#each files}}
      <ComponentRef Id="{{this.id}}" />
      {{/each}}

      {{#each directories}}
      {{> directory_feature.wxs}}
      {{/each}}

      <ComponentRef Id="ApplicationShortcuts" />
      <ComponentRef Id="DesktopShortcuts" />
    </Feature>

    <!-- 安装界面 -->
    <UIRef Id="WixUI_Advanced" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- 自定义文本 -->
    <WixVariable Id="WixUIDialogBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="dialog.bmp" />
    
    <!-- 升级规则 -->
    <Upgrade Id="{{upgrade-code}}">
      <UpgradeVersion Minimum="{{version}}" OnlyDetect="yes" Property="NEWERFOUND" />
      <UpgradeVersion Minimum="0.0.0" Maximum="{{version}}" IncludeMinimum="yes" IncludeMaximum="no" Property="OLDERFOUND" />
    </Upgrade>

    <!-- 安装序列 -->
    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallValidate" />
    </InstallExecuteSequence>

  </Product>
</Wix> 